<!DOCTYPE html><HTML lang="en"><head><script charset="utf-8" src="../../../../../assets/default/multidoc_injector.js" type="text/javascript"></script><script charset="utf-8" type="text/javascript">window.MULTIDOCUMENTER_ROOT_PATH = '/'</script><script charset="utf-8" src="../../../../../assets/default/flexsearch.bundle.js" type="text/javascript"></script><script charset="utf-8" src="../../../../../assets/default/flexsearch_integration.js" type="text/javascript"></script><meta charset="UTF-8"/><meta content="width=device-width, initial-scale=1.0" name="viewport"/><title>Callbacks · QuantumCollocation.jl</title><meta content="Callbacks · QuantumCollocation.jl" name="title"/><meta content="Callbacks · QuantumCollocation.jl" property="og:title"/><meta content="Callbacks · QuantumCollocation.jl" property="twitter:title"/><meta content="Documentation for QuantumCollocation.jl." name="description"/><meta content="Documentation for QuantumCollocation.jl." property="og:description"/><meta content="Documentation for QuantumCollocation.jl." property="twitter:description"/><meta content="https://docs.harmoniqs.co/QuantumCollocation.jl/generated/man/ipopt_callbacks/" property="og:url"/><meta content="https://docs.harmoniqs.co/QuantumCollocation.jl/generated/man/ipopt_callbacks/" property="twitter:url"/><link href="https://docs.harmoniqs.co/QuantumCollocation/dev/generated/man/ipopt_callbacks/" rel="canonical"/><script data-outdated-warner="" src="../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script data-main="../../../assets/documenter.js" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script><script src="../../../search_index.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" data-theme-name="catppuccin-mocha" href="../../../assets/themes/catppuccin-mocha.css" rel="stylesheet" type="text/css"/><link class="docs-theme-link" data-theme-name="catppuccin-macchiato" href="../../../assets/themes/catppuccin-macchiato.css" rel="stylesheet" type="text/css"/><link class="docs-theme-link" data-theme-name="catppuccin-frappe" href="../../../assets/themes/catppuccin-frappe.css" rel="stylesheet" type="text/css"/><link class="docs-theme-link" data-theme-name="catppuccin-latte" href="../../../assets/themes/catppuccin-latte.css" rel="stylesheet" type="text/css"/><link class="docs-theme-link" data-theme-name="documenter-dark" data-theme-primary-dark="" href="../../../assets/themes/documenter-dark.css" rel="stylesheet" type="text/css"/><link class="docs-theme-link" data-theme-name="documenter-light" data-theme-primary="" href="../../../assets/themes/documenter-light.css" rel="stylesheet" type="text/css"/><script src="../../../assets/themeswap.js"></script><link href="../../../../../assets/default/multidoc.css" rel="stylesheet" type="text/css"/><link href="../../../../../assets/default/flexsearch.css" rel="stylesheet" type="text/css"/></head><body><nav id="multi-page-nav"><div class="hidden-on-mobile" id="nav-items"><a class="nav-link nav-item" href="../../../../../Piccolo/">Piccolo</a><a class="nav-link nav-item" href="../../../../../PiccoloQuantumObjects/">Quantum Objects</a><div class="nav-dropdown"><button class="nav-item dropdown-label">Optimal Controls</button><ul class="nav-dropdown-container"><a class="nav-link active nav-item" href="../../../../">QuantumCollocation.jl</a><a class="nav-link nav-item" href="../../../../../QuantumCollocationCore/">QuantumCollocationCore.jl</a></ul></div><div class="nav-dropdown"><button class="nav-item dropdown-label">Trajectories</button><ul class="nav-dropdown-container"><a class="nav-link nav-item" href="../../../../../NamedTrajectories/">NamedTrajectories.jl</a><a class="nav-link nav-item" href="../../../../../TrajectoryIndexingUtils/">TrajectoryIndexingUtils.jl</a></ul></div><a class="nav-link nav-item" href="../../../../../PiccoloPlots/">Plots</a><div class="search nav-item"><input id="search-input" placeholder="Search everywhere..."/><ul class="suggestions hidden" id="search-result-container"></ul><div class="search-keybinding">/</div></div></div><button id="multidoc-toggler"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg></button></nav><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../../"><img alt="QuantumCollocation.jl logo" src="../../../assets/logo.svg"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../../">QuantumCollocation.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../../">Home</a></li><li><span class="tocitem">Manual</span><ul><li><a class="tocitem" href="../problem_templates/">Problem Templates</a></li><li><a class="tocitem" href="../rollouts/">Rollouts</a></li><li class="is-active"><a class="tocitem" href="">Callbacks</a><ul class="internal"><li><a class="tocitem" href="#Callbacks"><span>Callbacks</span></a></li><li><a class="tocitem" href="#Single-initial-and-target-states"><span>Single initial and target states</span></a></li><li><a class="tocitem" href="#Using-other-callbacks-from-the-callback-library"><span>Using other callbacks from the callback library</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../../../lib/">Library</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" href="#" id="documenter-sidebar-button"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Manual</a></li><li class="is-active"><a href="">Callbacks</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="">Callbacks</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/harmoniqs/QuantumCollocation.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/harmoniqs/QuantumCollocation.jl/blob/main/docs/literate/man/ipopt_callbacks.jl" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" href="#" id="documenter-settings-button" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" href="javascript:;" id="documenter-article-toggle-button" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="IpOpt-Callbacks"><a class="docs-heading-anchor" href="#IpOpt-Callbacks">IpOpt Callbacks</a><a id="IpOpt-Callbacks-1"></a><a class="docs-heading-anchor-permalink" href="#IpOpt-Callbacks" title="Permalink"></a></h1><p>This page describes the callback functions that can be used with the IpOpt solver (in the future, may describe more general callback behavior).</p><h2 id="Callbacks"><a class="docs-heading-anchor" href="#Callbacks">Callbacks</a><a id="Callbacks-1"></a><a class="docs-heading-anchor-permalink" href="#Callbacks" title="Permalink"></a></h2><pre><code class="language-julia hljs">using QuantumCollocation
using NamedTrajectories

import ..QuantumStateSmoothPulseProblem
import ..Callbacks</code></pre><p>By default, IpOpt callbacks are called at each optimization step with the following signature:</p><pre><code class="language-julia hljs">function full_argument_list_callback(
    alg_mod::Cint,
    iter_count::Cint,
    obj_value::Float64,
    inf_pr::Float64,
    inf_du::Float64,
    mu::Float64,
    d_norm::Float64,
    regularization_size::Float64,
    alpha_du::Float64,
    alpha_pr::Float64,
    ls_trials::Cint,
)
    return true
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">full_argument_list_callback (generic function with 1 method)</code></pre><p>This gives the user access to some of the optimization state internals at each iteration. A callback function with any subset of these arguments can be passed into the <code>solve!</code> function via the <code>callback</code> keyword argument see below.</p><p>The callback function can be used to stop the optimization early by returning <code>false</code>. The following callback when passed to <code>solve!</code> will stop the optimization after the first iteration:</p><pre><code class="language-julia hljs">my_callback = (kwargs...) -&gt; false</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">#1 (generic function with 1 method)</code></pre><h2 id="Single-initial-and-target-states"><a class="docs-heading-anchor" href="#Single-initial-and-target-states">Single initial and target states</a><a id="Single-initial-and-target-states-1"></a><a class="docs-heading-anchor-permalink" href="#Single-initial-and-target-states" title="Permalink"></a></h2><pre><code class="language-julia hljs">T = 50
Δt = 0.2
sys = QuantumSystem(0.1 * GATES[:Z], [GATES[:X], GATES[:Y]])
ψ_init =  Vector{ComplexF64}([1.0, 0.0])
ψ_target =  Vector{ComplexF64}([0.0, 1.0])

prob = QuantumStateSmoothPulseProblem(
    sys, ψ_init, ψ_target, T, Δt;
    ipopt_options=IpoptOptions(print_level=1),
    piccolo_options=PiccoloOptions(verbose=false)
)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">QuantumControlProblem(Ipopt.Optimizer
├ ObjectiveSense: MIN_SENSE
├ ObjectiveFunctionType: MOI.ScalarAffineFunction{Float64}
├ NumberOfVariables: 550
└ NumberOfConstraints: 747
  ├ MOI.VariableIndex in MOI.EqualTo{Float64}: 10
  ├ MOI.VariableIndex in MOI.GreaterThan{Float64}: 344
  ├ MOI.VariableIndex in MOI.LessThan{Float64}: 344
  └ MOI.ScalarAffineFunction{Float64} in MOI.EqualTo{Float64}: 49, MathOptInterface.VariableIndex[MOI.VariableIndex(1), MOI.VariableIndex(2), MOI.VariableIndex(3), MOI.VariableIndex(4), MOI.VariableIndex(5), MOI.VariableIndex(6), MOI.VariableIndex(7), MOI.VariableIndex(8), MOI.VariableIndex(9), MOI.VariableIndex(10)  …  MOI.VariableIndex(541), MOI.VariableIndex(542), MOI.VariableIndex(543), MOI.VariableIndex(544), MOI.VariableIndex(545), MOI.VariableIndex(546), MOI.VariableIndex(547), MOI.VariableIndex(548), MOI.VariableIndex(549), MOI.VariableIndex(550)], NamedTrajectories.StructNamedTrajectory.NamedTrajectory{Float64}([1.0 0.9795918367346939 … 0.020408163265306145 0.0; 0.0 0.02040816326530612 … 0.9795918367346939 1.0; … ; 0.00030459354778193117 -0.006779055412899477 … 0.0004114751771650177 -0.001467456128379232; 0.2 0.2 … 0.2 0.2], [1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.009425042464440958, 0.0014129879885249209, -0.006477407533546221, 0.00030459354778193117  …  1.0, 0.0, 0.0, 0.0, 0.0, 0.00694938351569948, 0.0048919130938391885, 0.010863787504255516, -0.001467456128379232, 0.2], 50, :Δt, 11, (ψ̃ = 4, a = 2, da = 2, dda = 2, Δt = 1, states = 8, controls = 3), (a = ([-1.0, -1.0], [1.0, 1.0]), da = ([-Inf, -Inf], [Inf, Inf]), dda = ([-1.0, -1.0], [1.0, 1.0]), Δt = ([0.0002], [0.4])), (ψ̃ = [1.0, 0.0, 0.0, 0.0], a = [0.0, 0.0]), (a = [0.0, 0.0],), (ψ̃ = [0.0, 1.0, 0.0, 0.0],), (ψ̃ = 1:4, a = 5:6, da = 7:8, dda = 9:10, Δt = 11:11, states = [1, 2, 3, 4, 5, 6, 7, 8], controls = [9, 10, 11]), NamedTuple(), 0, NamedTuple(), NamedTuple(), (:ψ̃, :a, :da, :dda, :Δt), (:ψ̃, :a, :da), (:dda, :Δt)), AbstractIntegrator[QuantumStatePadeIntegrator([1, 2, 3, 4], [5, 6], 11, true, 2, 2, 4, 11, 4, false, PiccoloQuantumObjects.QuantumSystems.var"#13#24"{Vector{SparseArrays.SparseMatrixCSC{Float64, Int64}}, SparseArrays.SparseMatrixCSC{Float64, Int64}}(SparseArrays.SparseMatrixCSC{Float64, Int64}[sparse([4, 3, 2, 1], [1, 2, 3, 4], [-1.0, -1.0, 1.0, 1.0], 4, 4), sparse([2, 1, 4, 3], [1, 2, 3, 4], [1.0, -1.0, 1.0, -1.0], 4, 4)], sparse([3, 4, 1, 2], [1, 2, 3, 4], [-0.1, 0.1, 0.1, -0.1], 4, 4)), PiccoloQuantumObjects.QuantumSystems.var"#14#25"{Vector{SparseArrays.SparseMatrixCSC{Float64, Int64}}}(SparseArrays.SparseMatrixCSC{Float64, Int64}[sparse([4, 3, 2, 1], [1, 2, 3, 4], [-1.0, -1.0, 1.0, 1.0], 4, 4), sparse([2, 1, 4, 3], [1, 2, 3, 4], [1.0, -1.0, 1.0, -1.0], 4, 4)])), DerivativeIntegrator([5, 6], [7, 8], true, 11, 11, 2, false), DerivativeIntegrator([7, 8], [9, 10], true, 11, 11, 2, false)], IpoptOptions{Float64}(1.0e-8, 100.0, 1000, 1.0e6, 1.0, 1.0e-6, 0.001, 1.0e-6, 15, 1.0e10, 0.01, 0.01, 1.0e-5, 1.0e8, 0.0001, 1, nothing, "no", "no", "no", "text", "no", "no", "original", 1, 0.0, "no", nothing, "limited-memory", "no", 1.0e-6, "mumps", 10, 3), PiccoloOptions(false, false, true, true, :pade, 4, ExponentialAction.expv, false, true, true, true, nothing, 1.0, false, false, 1.0, false, nothing, :ϕ), Dict{Symbol, Any}(:objective_terms =&gt; Dict[Dict{Symbol, Any}(:dim =&gt; 11, :times =&gt; 1:50, :R =&gt; [0.01, 0.01], :eval_hessian =&gt; true, :baseline =&gt; [0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0], :type =&gt; :QuadraticRegularizer, :name =&gt; :a), Dict{Symbol, Any}(:dim =&gt; 11, :times =&gt; 1:50, :R =&gt; [0.01, 0.01], :eval_hessian =&gt; true, :baseline =&gt; [0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0], :type =&gt; :QuadraticRegularizer, :name =&gt; :da), Dict{Symbol, Any}(:dim =&gt; 11, :times =&gt; 1:50, :R =&gt; [0.01, 0.01], :eval_hessian =&gt; true, :baseline =&gt; [0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0], :type =&gt; :QuadraticRegularizer, :name =&gt; :dda), Dict{Symbol, Any}(:loss =&gt; :InfidelityLoss, :eval_hessian =&gt; true, :type =&gt; :QuantumObjective, :Q =&gt; [100.0], :names =&gt; (:ψ̃,), :goals =&gt; ([0.0, 1.0, 0.0, 0.0],))], :linear_constraints =&gt; LinearConstraint[EqualityConstraint([1], [1, 2, 3, 4], [1.0, 0.0, 0.0, 0.0], 11, "initial value of ψ̃"), EqualityConstraint([1], [5, 6], [0.0, 0.0], 11, "initial value of a"), EqualityConstraint([49, 50], [5, 6], [0.0, 0.0], 11, "final value of a"), BoundsConstraint([2, 3, 4, 5, 6, 7, 8, 9, 10, 11  …  39, 40, 41, 42, 43, 44, 45, 46, 47, 48], 5:6, [(-1.0, 1.0), (-1.0, 1.0)], 11, "bounds on a"), BoundsConstraint([1, 2, 3, 4, 5, 6, 7, 8, 9, 10  …  41, 42, 43, 44, 45, 46, 47, 48, 49, 50], 7:8, [(-Inf, Inf), (-Inf, Inf)], 11, "bounds on da"), BoundsConstraint([1, 2, 3, 4, 5, 6, 7, 8, 9, 10  …  41, 42, 43, 44, 45, 46, 47, 48, 49, 50], 9:10, [(-1.0, 1.0), (-1.0, 1.0)], 11, "bounds on dda"), BoundsConstraint([1, 2, 3, 4, 5, 6, 7, 8, 9, 10  …  41, 42, 43, 44, 45, 46, 47, 48, 49, 50], 11:11, [(0.0002, 0.4)], 11, "bounds on Δt"), TimeStepsAllEqualConstraint([11, 22, 33, 44, 55, 66, 77, 88, 99, 110  …  451, 462, 473, 484, 495, 506, 517, 528, 539, 550], "time step all equal constraint")], :nonlinear_constraints =&gt; Any[]))</code></pre><p>The callback function can be used to monitor the optimization progress, save intermediate results, or modify the optimization process. For example, the following callback function saves the optimization trajectory at each iteration - this can be useful for debugging or plotting the optimization progress. <code>trajectory_history_callback</code> from the <code>Callbacks</code> module</p><pre><code class="language-julia hljs">callback, trajectory_history = QuantumCollocation.Callbacks.trajectory_history_callback(prob)
solve!(prob, max_iter=20, callback=callback)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">
******************************************************************************
This program contains Ipopt, a library for large-scale nonlinear optimization.
 Ipopt is released as open source code under the Eclipse Public License (EPL).
         For more information visit https://github.com/coin-or/Ipopt
******************************************************************************</code></pre><p>Save trajectory images into files which can be used to create a gif like the following:</p><pre><code class="language-julia hljs">for (iter, traj) in enumerate(trajectory_history)
    str_index = lpad(iter, length(string(length(trajectory_history))), "0")
    plot("./iteration-$str_index-trajectory.png", traj, [:ψ̃, :a], xlims=(-Δt, (T+5)*Δt), ylims=(ψ̃1 = (-2, 2), a = (-1.1, 1.1)))
end</code></pre><p><img alt="pulse optimization animation" src="../../assets/animation.gif"/></p><p>Using a callback to get the best trajectory from all the optimization iterations</p><pre><code class="language-julia hljs">sys2 = QuantumSystem(0.15 * GATES[:Z], [GATES[:X], GATES[:Y]])
ψ_init2 =  Vector{ComplexF64}([0.0, 1.0])
ψ_target2 =  Vector{ComplexF64}([1.0, 0.0])</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">2-element Vector{ComplexF64}:
 1.0 + 0.0im
 0.0 + 0.0im</code></pre><h2 id="Using-other-callbacks-from-the-callback-library"><a class="docs-heading-anchor" href="#Using-other-callbacks-from-the-callback-library">Using other callbacks from the callback library</a><a id="Using-other-callbacks-from-the-callback-library-1"></a><a class="docs-heading-anchor-permalink" href="#Using-other-callbacks-from-the-callback-library" title="Permalink"></a></h2><p>Callback used here is <code>best_rollout_fidelity_callback</code> which appends the best trajectories based on monotonically increasing fidelity of the rollout</p><pre><code class="language- hljs">prob2 = QuantumStateSmoothPulseProblem(
    sys2, ψ_init2, ψ_target2, T, Δt;
    ipopt_options=IpoptOptions(print_level=1),
    piccolo_options=PiccoloOptions(verbose=false)
)

best_trajectory_callback, best_trajectory_list = best_rollout_fidelity_callback(prob2)
solve!(prob2, max_iter=20, callback=best_trajectory_callback)</code></pre><p>fidelity of the last iterate</p><pre><code class="language- hljs">@show Losses.fidelity(prob2)</code></pre><p>fidelity of the best iterate</p><pre><code class="language- hljs">@show QuantumCollocation.fidelity(best_trajectory_list[end], prob2.system)</code></pre><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../rollouts/">« Rollouts</a><a class="docs-footer-nextpage" href="../../../lib/">Library »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label></p><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div><p></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.1 on <span class="colophon-date" title="Friday 28 February 2025 08:36">Friday 28 February 2025</span>. Using Julia version 1.11.3.</p></section><footer class="modal-card-foot"></footer></div></div></div><div data-docstringscollapsed="true"></div></body></HTML>